Although it's clear that the code is EXTREMELY verbose, at least it's able to pass all local tests. (
